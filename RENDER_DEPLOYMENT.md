# Render Deployment Guide

This guide covers deploying The Auto Doctor to Render with full cron job support.

---

## Prerequisites

- Render account ([render.com](https://render.com))
- GitHub repository connected to Render
- Supabase project with database configured
- Stripe account with webhook configured
- Resend account for email (or alternative email service)
- LiveKit account for video sessions

---

## Option 1: Deploy Using render.yaml (Recommended)

### Step 1: Push render.yaml to Your Repository

The `render.yaml` file in your repository root defines your infrastructure:
- **Web Service**: Your Next.js application
- **Cron Job**: Session monitoring (runs every 5 minutes)

```bash
git add render.yaml scripts/run-cron.js
git commit -m "Add Render deployment configuration"
git push
```

### Step 2: Create Services from Blueprint

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub repository
4. Select the repository with `render.yaml`
5. Click **"Apply"**

Render will automatically create:
- Web service for your app
- Cron job for session monitoring

### Step 3: Configure Environment Variables

In the Render dashboard, go to your **web service** and add these environment variables:

#### Required Variables:

```bash
# Node Environment
NODE_ENV=production

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Stripe
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...

# Email (Resend)
RESEND_API_KEY=re_...
EMAIL_FROM=The Auto Doctor <noreply@yourdomain.com>
SUPPORT_EMAIL=support@yourdomain.com

# Cron Security (auto-generated by Render)
CRON_SECRET=<let-render-generate-this>

# LiveKit
LIVEKIT_API_KEY=your-api-key
LIVEKIT_API_SECRET=your-api-secret
LIVEKIT_URL=wss://your-project.livekit.cloud

# App URL
NEXT_PUBLIC_APP_URL=https://your-app.onrender.com
```

**Note:** The `CRON_SECRET` will be auto-generated by Render. Copy it and add it to the cron job service as well.

---

## Option 2: Manual Deployment (Without render.yaml)

### Step 1: Create Web Service

1. Go to Render Dashboard
2. Click **"New +"** → **"Web Service"**
3. Connect your GitHub repository
4. Configure:
   - **Name**: `theautodoctor`
   - **Environment**: `Node`
   - **Region**: Choose nearest to your users
   - **Branch**: `main`
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Plan**: Choose based on your needs (Starter or higher)

5. Add all environment variables (see list above)

### Step 2: Create Cron Job Service

1. In Render Dashboard, click **"New +"** → **"Cron Job"**
2. Configure:
   - **Name**: `session-monitor-cron`
   - **Environment**: `Node`
   - **Region**: Same as your web service
   - **Branch**: `main`
   - **Schedule**: `*/5 * * * *` (every 5 minutes)
   - **Build Command**: `npm install`
   - **Start Command**: `node scripts/run-cron.js`

3. Add environment variables:
   ```bash
   APP_URL=https://your-app.onrender.com
   CRON_SECRET=<same-as-web-service>
   NEXT_PUBLIC_SUPABASE_URL=<same-as-web-service>
   SUPABASE_SERVICE_ROLE_KEY=<same-as-web-service>
   RESEND_API_KEY=<same-as-web-service>
   EMAIL_FROM=<same-as-web-service>
   SUPPORT_EMAIL=<same-as-web-service>
   ```

---

## Post-Deployment Steps

### 1. Run Database Migrations

After deployment, run the new migrations in Supabase Studio:

```sql
-- Migration 06: Session Extensions and Files
-- (Run this in Supabase SQL Editor)
-- See: migrations/06_session_extensions_and_files.sql

-- Migration 07: Session Summaries
-- (Run this in Supabase SQL Editor)
-- See: migrations/07_session_summaries.sql
```

### 2. Create Supabase Storage Bucket

1. Go to Supabase Dashboard → Storage
2. Create new bucket: `session-files`
3. Set to **Private**
4. Add RLS policies:

```sql
-- Allow session participants to upload
CREATE POLICY "Users can upload files to their sessions"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'session-files' AND
  (storage.foldername(name))[1] IN (
    SELECT id::text FROM sessions
    WHERE customer_user_id = auth.uid() OR mechanic_id = auth.uid()
  )
);

-- Allow session participants to download
CREATE POLICY "Users can download files from their sessions"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'session-files' AND
  (storage.foldername(name))[1] IN (
    SELECT id::text FROM sessions
    WHERE customer_user_id = auth.uid() OR mechanic_id = auth.uid()
  )
);
```

### 3. Configure Stripe Webhook

Update your Stripe webhook endpoint to point to your Render URL:

1. Go to [Stripe Dashboard → Webhooks](https://dashboard.stripe.com/webhooks)
2. Update endpoint URL to: `https://your-app.onrender.com/api/stripe/webhook`
3. Make sure these events are selected:
   - `checkout.session.completed`
   - `payment_intent.succeeded`

### 4. Test Cron Job

Test that the cron job is working:

1. Go to Render Dashboard → Your cron job
2. Click **"Trigger Run"** to manually run it
3. Check logs to verify it ran successfully
4. You should see output like:
   ```
   ✓ Cron job completed successfully
     - Mechanics nudged: 0
     - Support alerts: 0
     - Sessions auto-ended: 0
   ```

---

## Alternative: Use External Cron Service (Optional)

If you don't want to use Render's cron jobs (to save costs), you can use a free external cron service:

### Option A: cron-job.org

1. Sign up at [cron-job.org](https://cron-job.org)
2. Create a new cron job:
   - **URL**: `https://your-app.onrender.com/api/cron/monitor-sessions`
   - **Schedule**: Every 5 minutes
   - **Header**: `Authorization: Bearer YOUR_CRON_SECRET`
3. Enable the job

### Option B: EasyCron

1. Sign up at [easycron.com](https://www.easycron.com)
2. Create a new cron job:
   - **URL**: `https://your-app.onrender.com/api/cron/monitor-sessions`
   - **Cron Expression**: `*/5 * * * *`
   - **HTTP Header**: `Authorization: Bearer YOUR_CRON_SECRET`
3. Save and enable

---

## Monitoring & Logging

### View Web Service Logs

1. Go to Render Dashboard → Your web service
2. Click **"Logs"** tab
3. Monitor for errors or issues

### View Cron Job Logs

1. Go to Render Dashboard → Your cron job
2. Click **"Logs"** tab
3. Each run will show:
   - Timestamp
   - Number of actions taken
   - Any errors

### Monitor Cron Job Performance

Check that the cron job is working by:
- Looking at Render logs every 5 minutes
- Checking your email for nudge/alert emails (when triggered)
- Verifying stuck sessions are auto-resolved

---

## Troubleshooting

### Cron Job Not Running

**Problem**: Cron job doesn't execute on schedule

**Solutions**:
1. Check that `CRON_SECRET` matches between web service and cron job
2. Verify `APP_URL` is set correctly in cron job
3. Check cron job logs for errors
4. Manually trigger a run to test

### 401 Unauthorized Error

**Problem**: Cron endpoint returns 401

**Solutions**:
1. Verify `CRON_SECRET` environment variable is set
2. Check that `Authorization` header is being sent correctly
3. Ensure cron job has access to the secret

### Emails Not Sending

**Problem**: Nudge/alert emails not being sent

**Solutions**:
1. Verify `RESEND_API_KEY` is valid
2. Check that `EMAIL_FROM` uses a verified domain
3. Check Resend dashboard for failed sends
4. Look for email errors in cron job logs

### Sessions Not Auto-Ending

**Problem**: Long-running sessions not being closed

**Solutions**:
1. Check database for sessions with `status='live'` and old `started_at`
2. Verify cron job is running successfully
3. Check cron job logs for auto-end actions
4. Manually trigger cron job to test

---

## Cost Optimization

### Render Pricing

- **Web Service**: Starter plan ($7/month) or higher
- **Cron Job**: $1/month per cron job

### Saving Costs

If you want to save the $1/month cron job cost:
1. Delete the Render cron job
2. Use a free external cron service (cron-job.org or EasyCron)
3. Set it to call your `/api/cron/monitor-sessions` endpoint every 5 minutes

---

## Deployment Checklist

Before going live, verify:

- [ ] Web service deployed successfully
- [ ] Cron job deployed successfully (or external cron configured)
- [ ] All environment variables set correctly
- [ ] Database migrations run (06 and 07)
- [ ] Storage bucket created with RLS policies
- [ ] Stripe webhook pointing to Render URL
- [ ] Test cron job runs successfully
- [ ] Test file upload/download works
- [ ] Test session extension works
- [ ] Test summary submission works
- [ ] Emails are being sent (test with a real session)

---

## Support

If you encounter issues:
1. Check Render logs for errors
2. Check Supabase logs for database errors
3. Check Stripe dashboard for webhook failures
4. Check Resend dashboard for email failures
5. Review cron job logs for monitoring issues

---

**Last Updated**: 2025-01-24
